services:
  duckling:
    image: rasa/duckling:latest
    ports:
      - "8081:8080"

  redis-service:
    image: docker.io/library/redis:7-alpine
    ports: ["6379:6379"]

  chroma-service:
    image: chromadb/chroma:latest
    ports: ["8000:8000"]
    volumes:
      - ./PV/Chroma:/chroma/chroma
    environment:
      - PERSIST_DIRECTORY=/chroma/chroma
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
    command: ["run", "--host", "0.0.0.0", "--port", "8000", "--path", "/chroma/chroma"]

  image-server:
    image: docker.io/library/python:3.11-slim
    command: ["python", "-m", "http.server", "8000", "--directory", "/images"]
    volumes:
      - ./PV/Images:/images:ro
    ports: ["8090:8000"]

  vision-large-model:
    image: ghcr.io/ggml-org/llama.cpp:server
    volumes:
      - ./PV/GGUF:/models:ro
    ports: ["8083:8083"]
    command: >
      -m /models/Qwen3-VL-4B-Thinking-Q4_K_M.gguf
      --mmproj /models/Qwen3-VL-4B-Thinking-Q4_K_M-mmproj-F16.gguf
      --host 0.0.0.0
      --port 8083
      -c 4096
      --chat-template-file /models/qwen3_fixed_template.jinja
      --jinja
      --temp 1.0
      --top-p 0.95
      --presence-penalty 0.0
      --threads 6
      -np 1

  embed-model:
    image: ghcr.io/ggml-org/llama.cpp:server
    volumes:
      - ./PV/GGUF:/models:ro
    ports:
      - "8085:8085"
    command: >
      -m /models/Qwen.Qwen3-VL-Embedding-2B.Q4_K_M.gguf
      --mmproj /models/mmproj-Qwen.Qwen3-VL-Embedding-2B.f16.gguf
      --host 0.0.0.0
      --port 8085
      --embedding
      --threads 6
      --ctx-size 2048



  interface:
    build:
      context: ./interface
      dockerfile: Dockerfile.interface
    ports: ["8080:8080"]
    environment:
      - REDIS_HOST=redis-service
      - EXTERNAL_IMAGE_URL=http://localhost:8090
    depends_on:
      - redis-service

  camera_agent:
    build:
      context: ./camera_agent
      dockerfile: Dockerfile.camera_agent
    devices:
      - "/dev/video0:/dev/video0"
    volumes:
      - ./PV/Images:/app/images
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_HOST=redis-service
      - NODE_NAME=wyze_camera
      - CAMERA_INDEX=0
      - IMAGE_DIR=/app/images
      - BACKGROUND_INTERVAL=30
      - RTSP_URLS=rtsp://thingino:thingino@192.168.1.11/ch0
      - RTSP_THROWAWAY_FRAMES=5
      - RTSP_TIMEOUT_MS=10000
      - ENABLE_WEBCAM_FALLBACK=true
    depends_on:
      - redis-service

  vision_large:
    build:
      context: ./vision_large
      dockerfile: Dockerfile.vision_large
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_HOST=redis-service
      - LLM_URL=http://vision-large-model:8083/v1
      - IMAGE_SERVER_URL=http://image-server:8000
    depends_on:
      - redis-service
      - vision-large-model
      - image-server

  embed:
    build:
      context: ./embed
      dockerfile: Dockerfile.embed
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_HOST=redis-service
      - CHROMA_HOST=chroma-service
      - EMBED_LLM_URL=http://embed-model:8085
      - IMAGE_SERVER_URL=http://image-server:8000
      - DUCKLING_URL=http://duckling:8000
    depends_on:
      - redis-service
      - chroma-service
      - embed-model
      - duckling



  detector:
    build: ./detector          # directory containing Dockerfile and detector.py
    environment:
      - REDIS_HOST=redis-service
      - IMAGE_SERVER_URL=http://image-server:8000
      - SEG_MODEL=yolo26x-seg.pt
      - POSE_MODEL=yolo26x-pose.pt
      - OV_MODEL=yoloe-26x-seg-pf.pt
      - CONFIDENCE_THRESHOLD=0.3
      - HOSTNAME=detector-1
    depends_on:
      - redis-service
      - image-server
    restart: unless-stopped
